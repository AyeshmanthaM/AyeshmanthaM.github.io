<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Sync System</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007acc;
            padding-bottom: 10px;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }

        .test-section h3 {
            color: #007acc;
            margin-top: 0;
        }

        button {
            background: linear-gradient(135deg, #007acc, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: background 0.3s;
        }

        button:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
            white-space: pre-line;
            line-height: 1.5;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            position: relative;
        }

        .status.loading::before {
            content: '';
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #856404;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: translateY(-50%) rotate(0deg);
            }

            100% {
                transform: translateY(-50%) rotate(360deg);
            }
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }

        .config-section {
            background: #e7f3ff;
            border: 1px solid #007acc;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #f0f8ff;
            border-left: 4px solid #007acc;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîÑ Notion Project Sync System</h1>

        <div class="info-box">
            <strong>‚ÑπÔ∏è About this system:</strong><br>
            This page manages your Notion sync system and allows you to monitor and control synchronization between your
            Notion database and GitHub repository.
        </div>

        <!-- Quick Connectivity Test -->
        <div class="test-section" style="background-color: #f0f8ff; border-color: #007acc;">
            <h3>üåê Quick Connectivity Test</h3>
            <p>Test basic connectivity to your Cloudflare Worker before running detailed tests.</p>
            <button onclick="testConnectivity()">Test Connectivity</button>
            <div id="connectivityResult" class="status" style="display: none;"></div>
            <pre id="connectivityResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- Configuration Check -->
        <div class="test-section">
            <h3>üîß Configuration Check</h3>
            <p>Check if your Cloudflare Worker has the proper environment variables configured.</p>
            <button onclick="testConfiguration()">Check Configuration</button>
            <div id="configResult" class="status" style="display: none;"></div>
            <pre id="configResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- Notion Connection Test -->
        <div class="test-section">
            <h3>üìã Notion Database Test</h3>
            <p>Test direct connection to your Notion database and fetch project data.</p>
            <button onclick="testNotionConnection()">Test Notion Connection</button>
            <div id="notionResult" class="status" style="display: none;"></div>
            <pre id="notionResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- Sync Status Check -->
        <div class="test-section">
            <h3>üìä Sync Status</h3>
            <p>Check the current status of your data synchronization system.</p>
            <button onclick="checkSyncStatus()">Check Sync Status</button>
            <div id="statusResult" class="status" style="display: none;"></div>
            <pre id="statusResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- Full Data Sync -->
        <div class="test-section">
            <h3>üöÄ Full Data Sync</h3>
            <p>Perform a complete synchronization of your Notion projects to the public data folder.</p>
            <div class="info-box">
                <strong>‚ö†Ô∏è Note:</strong> This operation may take 30-60 seconds depending on the number of projects and
                images. Please be patient.
            </div>
            <label>
                <input type="checkbox" id="includeImages" checked> Include images in sync
            </label><br>
            <label>
                <input type="checkbox" id="forceSync"> Force complete resync (ignores cache)
            </label><br><br>
            <button onclick="performFullSync()" id="syncButton">Start Full Sync</button>
            <div id="syncResult" class="status" style="display: none;"></div>
            <pre id="syncResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- Debug Information -->
        <div class="test-section">
            <h3>üîç Debug Information</h3>
            <p>Get detailed debug information about your Notion database properties.</p>
            <button onclick="getDebugInfo()">Get Debug Info</button>
            <div id="debugResult" class="status" style="display: none;"></div>
            <pre id="debugResponse" class="response" style="display: none;"></pre>
        </div>

        <!-- File Cleanup Test -->
        <div class="test-section">
            <h3>üóëÔ∏è File Cleanup Test</h3>
            <p>Test the file deletion feature by checking for orphaned files that should be removed during sync.</p>
            <button onclick="testFileCleanup()">Test File Cleanup</button>
            <div id="cleanupResult" class="status" style="display: none;"></div>
            <pre id="cleanupResponse" class="response" style="display: none;"></pre>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
            element.style.display = 'block';
        }

        function showResponse(elementId, data) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.style.display = 'block';
        }

        async function makeRequest(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (body) {
                options.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, options);

                // Check if response is ok before parsing JSON
                if (response.ok) {
                    const data = await response.json();
                    return { response, data };
                } else {
                    // Handle non-200 responses
                    let errorData;
                    try {
                        errorData = await response.json();
                    } catch (e) {
                        errorData = { error: `HTTP ${response.status}: ${response.statusText}` };
                    }
                    return { response, data: errorData };
                }
            } catch (error) {
                // Handle network errors
                return {
                    response: { ok: false, status: 0 },
                    data: { error: `Network error: ${error.message}` }
                };
            }
        }

        async function testConnectivity() {
            showStatus('connectivityResult', 'loading', 'Testing basic connectivity...');

            try {
                // Test a simple endpoint that should always respond
                const { response, data } = await makeRequest('/api/debug');

                if (response.ok) {
                    showStatus('connectivityResult', 'success',
                        '‚úÖ Connected successfully to Cloudflare Worker');
                } else if (response.status === 0) {
                    showStatus('connectivityResult', 'error',
                        '‚ùå Cannot connect to worker. Check if your proxy is configured correctly.');
                } else {
                    showStatus('connectivityResult', 'error',
                        `‚ùå Worker responded with error: HTTP ${response.status}`);
                }

                showResponse('connectivityResponse', data);
            } catch (error) {
                showStatus('connectivityResult', 'error',
                    `‚ùå Network error: ${error.message}. Check your internet connection and proxy configuration.`);
                showResponse('connectivityResponse', { error: error.message });
            }
        }

        async function testConfiguration() {
            showStatus('configResult', 'loading', 'Checking configuration...');

            try {
                const { response, data } = await makeRequest('/api/debug');

                if (response.ok) {
                    const hasRequiredConfig = data.hasToken && data.hasDatabase;
                    showStatus('configResult', hasRequiredConfig ? 'success' : 'error',
                        hasRequiredConfig ? 'Configuration looks good!' : 'Missing required configuration');
                } else {
                    showStatus('configResult', 'error', `Configuration check failed: ${data.error || 'Unknown error'}`);
                }

                showResponse('configResponse', data);
            } catch (error) {
                showStatus('configResult', 'error', `Network error: ${error.message}`);
                showResponse('configResponse', { error: error.message });
            }
        }

        async function testNotionConnection() {
            showStatus('notionResult', 'loading', 'Testing Notion connection...');

            try {
                const { response, data } = await makeRequest('/api/projects');

                if (response.ok && Array.isArray(data)) {
                    showStatus('notionResult', 'success', `Successfully fetched ${data.length} projects from Notion`);
                } else {
                    showStatus('notionResult', 'error', `Notion connection failed: ${data.error || 'Unknown error'}`);
                }

                showResponse('notionResponse', data);
            } catch (error) {
                showStatus('notionResult', 'error', `Network error: ${error.message}`);
                showResponse('notionResponse', { error: error.message });
            }
        }

        async function checkSyncStatus() {
            showStatus('statusResult', 'loading', 'Checking sync status...');

            try {
                const { response, data } = await makeRequest('/api/data/status');

                if (response.ok && data.status) {
                    const isOperational = data.status === 'operational';
                    let statusMessage = '';

                    if (isOperational) {
                        const features = [];
                        if (data.features?.notionSync) features.push('Notion');
                        if (data.features?.githubIntegration) features.push('GitHub');
                        if (data.features?.imageManagement) features.push('Images');

                        statusMessage = `‚úÖ System operational with: ${features.join(', ')}`;
                    } else {
                        statusMessage = `‚ùå System has issues: ${data.error || 'Unknown status'}`;
                    }

                    showStatus('statusResult', isOperational ? 'success' : 'error', statusMessage);
                } else {
                    showStatus('statusResult', 'error',
                        `Status check failed: ${data.error || response.statusText || 'Unknown error'}`);
                }

                showResponse('statusResponse', data);
            } catch (error) {
                showStatus('statusResult', 'error', `Network error: ${error.message}`);
                showResponse('statusResponse', { error: error.message });
            }
        }

        async function performFullSync() {
            const syncButton = document.getElementById('syncButton');
            const originalText = syncButton.textContent;

            // Disable button and show progress
            syncButton.disabled = true;
            syncButton.textContent = 'Syncing... Please wait';

            // Create detailed progress display
            const progressSteps = [
                '1Ô∏è‚É£ Initializing sync request...',
                '2Ô∏è‚É£ Connecting to Notion API...',
                '3Ô∏è‚É£ Fetching projects from Notion database...',
                '4Ô∏è‚É£ Processing project data and content blocks...',
                '5Ô∏è‚É£ Transforming data for public folder structure...',
                '6Ô∏è‚É£ Checking GitHub integration status...',
                '7Ô∏è‚É£ Creating/updating project JSON files...',
                '8Ô∏è‚É£ Updating metadata.json with project index...',
                '9Ô∏è‚É£ Finalizing sync and cleanup...',
                '‚úÖ Sync completed successfully!'
            ];

            let currentStep = 0;

            // Show initial progress
            showStatus('syncResult', 'loading', progressSteps[currentStep]);

            // Auto-advance progress steps during sync
            const progressInterval = setInterval(() => {
                currentStep++;
                if (currentStep < progressSteps.length - 1) {
                    showStatus('syncResult', 'loading', progressSteps[currentStep]);
                }
            }, 800); // Update every 800ms

            try {
                const body = {
                    includeImages: document.getElementById('includeImages').checked,
                    force: document.getElementById('forceSync').checked
                };

                const { response, data } = await makeRequest('/api/data/sync', 'POST', body);

                // Clear progress interval
                clearInterval(progressInterval);

                if (response.ok && data.success) {
                    const projectCount = data.data?.projectCount || 0;
                    const githubUpdated = data.data?.githubUpdated ? ' (GitHub updated)' : ' (Local only)';
                    const syncTime = data.data?.syncTimestamp ? new Date(data.data.syncTimestamp).toLocaleString() : 'Unknown';

                    // Show detailed success message
                    const successMessage = `
                        üéâ Full Sync Process Completed Successfully!
                        
                        üìä Results:
                        ‚Ä¢ Projects synchronized: ${projectCount}
                        ‚Ä¢ GitHub integration: ${githubUpdated}
                        ‚Ä¢ Sync timestamp: ${syncTime}
                        
                        üìÅ Files created/updated:
                        ‚Ä¢ public/data/metadata.json
                        ${data.data?.projects ? data.data.projects.map(p => `‚Ä¢ public/data/projects/${p.id}.json`).join('\n                        ') : ''}
                        
                        üåê Access URLs (once GitHub Pages updates):
                        ‚Ä¢ https://ayeshmantham.github.io/data/metadata.json
                        ${data.data?.projects ? data.data.projects.map(p => `‚Ä¢ https://ayeshmantham.github.io/data/projects/${p.id}.json`).join('\n                        ') : ''}
                    `;

                    showStatus('syncResult', 'success', successMessage);
                } else if (response.ok && !data.success) {
                    clearInterval(progressInterval);
                    showStatus('syncResult', 'error',
                        `‚ùå Sync Process Failed at Step ${currentStep + 1}: ${data.error || data.details || 'Unknown sync error'}`);
                } else {
                    clearInterval(progressInterval);
                    showStatus('syncResult', 'error',
                        `‚ùå Request Failed at Step ${currentStep + 1}: ${data.error || response.statusText || 'Unknown request error'}`);
                }

                showResponse('syncResponse', data);
            } catch (error) {
                clearInterval(progressInterval);
                showStatus('syncResult', 'error', `‚ùå Network Error at Step ${currentStep + 1}: ${error.message}`);
                showResponse('syncResponse', { error: error.message });
            } finally {
                // Re-enable button
                syncButton.disabled = false;
                syncButton.textContent = originalText;
            }
        }

        async function getDebugInfo() {
            showStatus('debugResult', 'loading', 'Getting debug information...');

            try {
                const { response, data } = await makeRequest('/api/debug/properties');

                if (response.ok) {
                    showStatus('debugResult', 'success', 'Debug information retrieved successfully');
                } else {
                    showStatus('debugResult', 'error', `Debug info failed: ${data.error || 'Unknown error'}`);
                }

                showResponse('debugResponse', data);
            } catch (error) {
                showStatus('debugResult', 'error', `Network error: ${error.message}`);
                showResponse('debugResponse', { error: error.message });
            }
        }

        async function testFileCleanup() {
            showStatus('cleanupResult', 'loading', 'Testing file cleanup functionality...');

            try {
                showResponse('cleanupResponse', { message: 'Performing sync with cleanup test...' });

                // Step 1: Get current project list from Notion
                const { response: projectsResponse, data: projectsData } = await makeRequest('/api/projects');

                if (!projectsResponse.ok) {
                    throw new Error('Failed to fetch projects from Notion');
                }

                const currentProjects = projectsData.map(p => ({
                    id: `project-${p.id.replace(/-/g, '')}`,
                    title: p.title
                }));

                // Step 2: Perform sync and check for file operations
                const { response: syncResponse, data: syncData } = await makeRequest('/api/data/sync', 'POST', {
                    action: 'cleanup-test',
                    includeImages: false
                });

                const testResult = {
                    step1_currentProjects: {
                        count: currentProjects.length,
                        projects: currentProjects
                    },
                    step2_syncResult: syncData,
                    step3_analysis: {}
                };

                // Step 3: Analyze the sync results
                if (syncData.success && syncData.data) {
                    const syncedCount = syncData.data.projectCount;
                    testResult.step3_analysis = {
                        notionProjects: syncedCount,
                        githubUpdateSuccess: syncData.data.githubUpdated,
                        syncTimestamp: syncData.data.syncTimestamp,
                        fileCleanupFeature: 'enabled - checks for orphaned files and removes them'
                    };

                    if (syncData.data.githubUpdated) {
                        testResult.step3_analysis.githubOperations = 'Files were updated in GitHub repository';
                    } else {
                        testResult.step3_analysis.githubOperations = 'No GitHub operations performed (check token)';
                    }
                } else {
                    testResult.step3_analysis.error = 'Sync failed or returned unexpected data';
                }

                showStatus('cleanupResult', 'success',
                    `File cleanup test completed. Found ${currentProjects.length} projects in Notion.`);
                showResponse('cleanupResponse', testResult);

            } catch (error) {
                showStatus('cleanupResult', 'error', `File cleanup test failed: ${error.message}`);
                showResponse('cleanupResponse', { error: error.message, stack: error.stack });
            }
        }

        // Auto-run connectivity and configuration check on page load
        window.onload = function () {
            console.log('üöÄ Notion Sync Test Page Loaded');
            console.log('üîó API Base URL:', API_BASE);

            // Run connectivity test first, then configuration
            setTimeout(() => {
                testConnectivity().then(() => {
                    setTimeout(() => {
                        testConfiguration();
                    }, 1000);
                });
            }, 500);
        };
    </script>
</body>

</html>